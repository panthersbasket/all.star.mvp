<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Resultados Partidos</title>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet" />
  <style>
    :root {
      --nav-height: 65px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Poppins', 'Arial', sans-serif;
      min-height: 100vh;
      background: linear-gradient(90deg, #096BB3 0%, #BF1723 100%);
      color: #fff;
      padding-bottom: calc(var(--nav-height) + var(--safe-bottom));
      overflow-x: hidden;
    }
    .top-bar {
      position: sticky;
      top: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      padding-top: calc(var(--safe-top) + 24px);
      padding-bottom: 12px;
      z-index: 100;
    }
    .back-button {
      background: #000;
      color: #fff;
      padding: 8px 20px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 13px;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
    }
    .view {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 16px;
      width: 100%;
      margin: 0;
    }
    .view h1 {
      font-family: 'Anton', sans-serif;
      text-align: center;
      font-size: 1.6rem;
      text-transform: uppercase;
      margin: 6px 0;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.6), 0 0 8px #000;
    }
    #loader { text-align: center; font-size: 1rem; font-weight: bold; color: #ffdddd; }
    .partidos { display: none; flex-direction: column; gap: 14px; margin-top: 10px; }
    .partido {
      background: rgba(0,0,0,0.6);
      padding: 14px;
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 0 10px rgba(191,23,35,0.4), 0 0 10px rgba(9,107,179,0.4);
    }
    .equipos {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .equipo { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .equipo img {
      width: 54px; height: 54px; border-radius: 12px; object-fit: cover;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }
    .nombre { font-family: 'Anton', sans-serif; font-size: 0.95rem; text-transform: uppercase; }
    .puntos { font-family: 'Anton', sans-serif; font-size: 2rem; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.75); }
    .vs-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 72px; }
    .vs { font-family: 'Anton', sans-serif; font-size: 1rem; color: #BF1723; font-weight: bold; text-shadow: 0 0 6px #BF1723; }
    .estado-txt { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; }
    .estado-txt.finalizado { color: #FF4C4C; }
    .estado-txt.enjuego { color: #4CFF4C; }
    .estado-txt.porjugar { color: #FFD700; }
    .link-partido { margin-top: 3px; font-size: 0.75rem; font-weight: 700; }
    .link-partido a { color: #0D6EFD; text-decoration: underline; }
    .fecha-hora { font-size: 0.9rem; margin-top: 8px; color: #ffffff; }
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: rgba(0,0,0,0.85);
      display: flex; justify-content: space-around; align-items: center;
      padding: 8px 0 calc(8px + var(--safe-bottom));
      border-top: 2px solid #BF1723;
      height: var(--nav-height);
      backdrop-filter: blur(5px);
      z-index: 1000;
    }
    .bottom-nav a {
      color: #fff; text-decoration: none; text-align: center; font-size: 8px;
      display: flex; flex-direction: column; align-items: center;
      max-width: 60px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .bottom-nav a.active { color: #BF1723; }
    .bottom-nav a.active img {
      filter: invert(28%) sepia(94%) saturate(7470%) hue-rotate(350deg) brightness(96%) contrast(92%);
    }
    .bottom-nav img { width: 22px; height: 22px; margin-bottom: 3px; }
    @media (max-width: 380px) {
      .equipo img { width: 50px; height: 50px; }
      .puntos { font-size: 1.9rem; }
      .vs-container { min-width: 64px; }
      .view h1 { font-size: 1.45rem; }
    }
  </style>
</head>
<body>

  <!-- Bot√≥n atr√°s inteligente -->
  <div class="top-bar">
    <button class="back-button" onclick="backSmart()">‚Üê Atr√°s</button>
  </div>

  <!-- Vista Resultados -->
  <div class="view">
    <h1>Resultados Partidos</h1>
    <div id="loader">üèÄ Cargando partidos...</div>
    <div class="partidos" id="partidosContainer"></div>
  </div>
<!-- Barra nav inferior -->
  <nav class="bottom-nav">
    <a href="index.html">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/home.png" alt="Inicio"/>
      Inicio
    </a>
    <a href="mvp.html">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/combo-chart.png" alt="Mvp Torneo"/>
      MVP del Torneo
    </a>
    <a href="partidos.html" class="active">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/calendar.png" alt="Partidos"/>
      Partidos
    </a>
    <a href="votaciones.html">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/ballot.png" alt="Votaciones"/>
      Votaciones
    </a>
    <a href="reglamento.html">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/rules.png" alt="Reglamento"/>
      Reglamento
    </a>
  </nav>

  <script>
    // Bot√≥n atr√°s inteligente
    function backSmart() {
      const hasReferrer = document.referrer && document.referrer !== location.href;
      if (hasReferrer || history.length > 1) {
        history.back();
      } else {
        window.location.href = 'index.html';
      }
    }

    // URL del CSV de resultados (tu hoja publicada como CSV)
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqS8AD-IUfniSrshjttdcygDajr72weBdghArEnFtpfiMEQwh5CVv6JHGlSd8jAEdXCU8G9NAB6sbi/pub?gid=0&single=true&output=csv";

    const partidosContainer = document.getElementById("partidosContainer");
    const loader = document.getElementById("loader");

    // Utilidades CSV
    function parseCSVLine(line) { return line.split(",").map(c => c.trim()); }
    function estadoClase(estado) { return (estado || "").toLowerCase().replace(/\s/g, ''); }
    function parseFechaHora(fecha, hora) {
      if (!fecha || !hora) return null;
      const [d, m, yRaw] = fecha.split("/");
      if (!d || !m || !yRaw) return null;
      const y = yRaw.length === 2 ? `20${yRaw}` : yRaw;
      return new Date(`${y}-${m}-${d}T${hora}`);
    }

    // Cargar resultados desde Google Sheets
    async function cargarResultados() {
      try {
        loader.style.display = "block";
        partidosContainer.style.display = "none";

        const res = await fetch(SHEET_URL, { cache: "no-store" });
        const texto = await res.text();
        const filas = texto.split("\n").map(l => l.trim()).filter(l => l.length);
        filas.shift(); // quitar cabecera

        let partidos = filas.map(fila => {
          const [
            eq1, foto1, eq2, foto2,
            fecha, hora, puntos1, puntos2,
            estadoRaw, linkRaw
          ] = parseCSVLine(fila);

          const estadoTexto = (estadoRaw || "").trim();
          const estado = estadoClase(estadoTexto);
          const link = (linkRaw || "").trim();
          const fechaHora = parseFechaHora(fecha, hora);

          return { eq1, foto1, eq2, foto2, fecha, hora, puntos1, puntos2, estado, estadoTexto, link, fechaHora };
        });

        // Orden: En juego -> Por jugar -> Finalizado; luego por fecha/hora ascendente
        const ordenEstado = { enjuego: 0, porjugar: 1, finalizado: 2 };
        partidos.sort((a, b) => {
          const diffEstado = (ordenEstado[a.estado] ?? 3) - (ordenEstado[b.estado] ?? 3);
          if (diffEstado !== 0) return diffEstado;
          if (a.fechaHora && b.fechaHora) return a.fechaHora - b.fechaHora;
          if (a.fechaHora && !b.fechaHora) return -1;
          if (!a.fechaHora && b.fechaHora) return 1;
          return 0;
        });

        // Render
        partidosContainer.innerHTML = "";
        if (partidos.length === 0) {
          partidosContainer.innerHTML = `<div class="partido"><p>No hay partidos disponibles por ahora.</p></div>`;
        } else {
          partidos.forEach(p => {
            const div = document.createElement("div");
            div.className = "partido";
            div.innerHTML = `
              <div class="equipos">
                <div class="equipo">
                  <img src="img/${(p.foto1 || 'default.png')}" alt="${p.eq1 || ''}" onerror="this.src='img/default.png'">
                  <span class="nombre">${p.eq1 || ''}</span>
                  <span class="puntos">${p.puntos1 || '0'}</span>
                </div>

                <div class="vs-container">
                  <span class="vs">VS</span>
                  ${p.estado ? `<span class="estado-txt ${p.estado}">${p.estadoTexto || ''}</span>` : ""}
                  ${p.link ? `<div class="link-partido"><a href="${p.link}" target="_blank" rel="noopener noreferrer">LINK PARTIDO</a></div>` : ""}
                </div>

                <div class="equipo">
                  <img src="img/${(p.foto2 || 'default.png')}" alt="${p.eq2 || ''}" onerror="this.src='img/default.png'">
                  <span class="nombre">${p.eq2 || ''}</span>
                  <span class="puntos">${p.puntos2 || '0'}</span>
                </div>
              </div>

              ${(p.fecha || p.hora) ? `<p class="fecha-hora">${(p.fecha || '')}${p.hora ? ' ¬∑ ' + p.hora : ''}</p>` : ''}
            `;
            partidosContainer.appendChild(div);
          });
        }

        loader.style.display = "none";
        partidosContainer.style.display = "flex";
      } catch (error) {
        console.error("Error leyendo Google Sheet:", error);
        loader.textContent = "‚ùå Error cargando partidos";
      }
    }

    // Cargar al entrar y auto-refresh cada 30s
    cargarResultados();
    setInterval(() => { cargarResultados(); }, 30000);
  </script>
</body>
</html>
